<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Insurer Profile</title>
    <link rel="stylesheet" href="profiles.css" type="text/css">
  </head>
  <body>
    <h1 id="welcome">Welcome Insurer</h1>
    <h2>List of Patients</h2>
    <!--A container for all the insurer's Clients-->
    <ul id="patient_list"></ul>
    <h2>Support Messages</h2>
    <ul id="patient_messages_list"></ul>
    <p>click here to sign out</p>
    <button id="signout_btn">Sign Out</button>
    <script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-firestore.js"></script>
    <script type="text/javascript">
      // Web app's Firebase configuration
      var firebaseConfig = {
        apiKey: "AIzaSyCIrRQLlsAzssCKjevk9AwFloPLrWSCfHk",
        authDomain: "mediscreen-674eb.firebaseapp.com",
        databaseURL: "https://mediscreen-674eb.firebaseio.com",
        projectId: "mediscreen-674eb",
        storageBucket: "mediscreen-674eb.appspot.com",
        messagingSenderId: "292545820886",
        appId: "1:292545820886:web:9fe5753b475a2f524b3177",
        measurementId: "G-FCP7TQ40TP"
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);

      const welcome = document.getElementById('welcome');
      const signoutbut = document.getElementById('signout_btn');
      const auth = firebase.auth();
      const db = firebase.firestore();

      //Signs user out
      signoutbut.addEventListener('click', e => {
        firebase.auth().signOut();

      });
      //Detects if the user is signed in or not
      firebase.auth().onAuthStateChanged(fireBaseUser => {
        if(fireBaseUser){
          console.log(fireBaseUser);

          var insref = null;
          //Getting the reference for the document matching the userID in the insurers collection
          var docRef = db.collection("insurers").doc(fireBaseUser.uid);
          docRef.get().then(function(doc) {
              if (doc.exists) {
                //gets reference to the Employee_ID field in the insurer data.
                  insref = doc.data().Employee_ID;
                  //If the doc exists, query the patient collection for clients with
                  //a matching Registered_Insurer field to the reference
                  db.collection('patients').where('Registered_Insurer','==',insref).get().then(snapshot =>{
                    outputPatients(snapshot.docs);
                  })

                  db.collection('support').where('Insurer_ID','==',insref).get().then(snapshot =>{
                    outputMessages(snapshot.docs);
                  })

                  const firstname = doc.data().First_Name;
                  const lastname = doc.data().Last_Name;
                  //Sets the Header to say welcome to the insurer by name.
                  welcome.innerHTML = 'Welcome'+' '+firstname+' '+lastname;
              } else {
                  console.log("No such document!");
              }
          }).catch(function(error) {
              console.log("Error getting document:", error);
          });
          //If the user is signed in, make the signout button visible
          signoutbut.style.display = "block";
        }else{
          console.log('not logged in');
          signoutbut.style.display = "none";
          //Redirect user to the main log in page when they log out
          window.location = 'insurer.html';
        }
      });
    </script>
    <script src="insdbdisplay.js"></script>
  </body>
</html>
